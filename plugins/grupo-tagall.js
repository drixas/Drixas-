const handler = async (m, { isOwner, isAdmin, conn, text, participants, args }) => {
  let chat = global.db.data.chats[m.chat];
  let emoji = chat.emojiTag || 'â˜…ðŸ’¨';

  // Validar que sea admin o owner
  if (!(isAdmin || isOwner)) {
    global.dfail('admin', m, conn);
    throw false;
  }

  const pesan = args.join(' ');
  const groupMetadata = await conn.groupMetadata(m.chat);
  const groupName = groupMetadata.subject;

  // Mapeo de prefijos telefÃ³nicos a banderas
  const countryFlags = {
    // AmÃ©rica y Caribe
      '1': 'ðŸ‡ºðŸ‡¸',
      '1242': 'ðŸ‡§ðŸ‡¸',
      '1246': 'ðŸ‡§ðŸ‡§',
      '1264': 'ðŸ‡¦ðŸ‡®',
      '1268': 'ðŸ‡©ðŸ‡²',
      '1284': 'ðŸ‡»ðŸ‡¬',
      '1340': 'ðŸ‡»ðŸ‡®',
      '1473': 'ðŸ‡¬ðŸ‡©',
      '1649': 'ðŸ‡¹ðŸ‡¨',
      '1664': 'ðŸ‡²ðŸ‡¸',
      '1671': 'ðŸ‡¬ðŸ‡º',
      '1758': 'ðŸ‡±ðŸ‡¨',
      '1767': 'ðŸ‡©ðŸ‡²',
      '1784': 'ðŸ‡¸ðŸ‡½',
      '1787': 'ðŸ‡µðŸ‡·',
      '1809': 'ðŸ‡©ðŸ‡´',
      '1829': 'ðŸ‡©ðŸ‡´',
      '1849': 'ðŸ‡©ðŸ‡´',
      '1868': 'ðŸ‡¹ðŸ‡¹',
      '1876': 'ðŸ‡¯ðŸ‡²',
      '52': 'ðŸ‡²ðŸ‡½',
      '53': 'ðŸ‡¨ðŸ‡º',
      '54': 'ðŸ‡¦ðŸ‡·',
      '55': 'ðŸ‡§ðŸ‡·',
      '56': 'ðŸ‡¨ðŸ‡±',
      '57': 'ðŸ‡¨ðŸ‡´',
      '58': 'ðŸ‡»ðŸ‡ª',
      '506': 'ðŸ‡¨ðŸ‡·',
      '507': 'ðŸ‡µðŸ‡¦',
      '590': 'ðŸ‡¬ðŸ‡µ',
      '591': 'ðŸ‡§ðŸ‡´',
      '592': 'ðŸ‡¬ðŸ‡¾',
      '593': 'ðŸ‡ªðŸ‡¨',
      '594': 'ðŸ‡¬ðŸ‡«',
      '595': 'ðŸ‡µðŸ‡¾',
      '596': 'ðŸ‡²ðŸ‡¶',
      '597': 'ðŸ‡¸ðŸ‡·',
      '598': 'ðŸ‡ºðŸ‡¾',
      '599': 'ðŸ‡¨ðŸ‡¼',
      '504': 'ðŸ‡­ðŸ‡³',
      '505': 'ðŸ‡³ðŸ‡®',
      '51' : 'ðŸ‡µðŸ‡ª',

      // Europa
      '30': 'ðŸ‡¬ðŸ‡·',
      '31': 'ðŸ‡³ðŸ‡±',
      '32': 'ðŸ‡§ðŸ‡ª',
      '33': 'ðŸ‡«ðŸ‡·',
      '34': 'ðŸ‡ªðŸ‡¸',
      '36': 'ðŸ‡­ðŸ‡º',
      '39': 'ðŸ‡®ðŸ‡¹',
      '40': 'ðŸ‡·ðŸ‡´',
      '41': 'ðŸ‡¨ðŸ‡­',
      '43': 'ðŸ‡¦ðŸ‡¹',
      '44': 'ðŸ‡¬ðŸ‡§',
      '45': 'ðŸ‡©ðŸ‡°',
      '46': 'ðŸ‡¸ðŸ‡ª',
      '47': 'ðŸ‡³ðŸ‡´',
      '48': 'ðŸ‡µðŸ‡±',
      '49': 'ðŸ‡©ðŸ‡ª',

      // Asia y OceanÃ­a
      '60': 'ðŸ‡²ðŸ‡¾',
      '61': 'ðŸ‡¦ðŸ‡º',
      '62': 'ðŸ‡®ðŸ‡©',
      '63': 'ðŸ‡µðŸ‡­',
      '64': 'ðŸ‡³ðŸ‡¿',
      '65': 'ðŸ‡¸ðŸ‡¬',
      '66': 'ðŸ‡¹ðŸ‡­',
      '81': 'ðŸ‡¯ðŸ‡µ',
      '82': 'ðŸ‡°ðŸ‡·',
      '84': 'ðŸ‡»ðŸ‡³',
      '86': 'ðŸ‡¨ðŸ‡³',
      '90': 'ðŸ‡¹ðŸ‡·',
      '91': 'ðŸ‡®ðŸ‡³',
      '92': 'ðŸ‡µðŸ‡°',
      '93': 'ðŸ‡¦ðŸ‡«',
      '94': 'ðŸ‡±ðŸ‡°',
      '95': 'ðŸ‡²ðŸ‡²',
      '98': 'ðŸ‡®ðŸ‡·',

      // Ãfrica
      '212': 'ðŸ‡²ðŸ‡¦',
      '213': 'ðŸ‡©ðŸ‡¿',
      '216': 'ðŸ‡¹ðŸ‡³',
      '218': 'ðŸ‡±ðŸ‡¾',
      '220': 'ðŸ‡¬ðŸ‡²',
      '221': 'ðŸ‡¸ðŸ‡³',
      '222': 'ðŸ‡²ðŸ‡·',
      '223': 'ðŸ‡²ðŸ‡±',
      '224': 'ðŸ‡¬ðŸ‡³',
      '225': 'ðŸ‡¨ðŸ‡®',
      '226': 'ðŸ‡§ðŸ‡«',
      '227': 'ðŸ‡³ðŸ‡ª',
      '228': 'ðŸ‡¹ðŸ‡¬',
      '229': 'ðŸ‡§ðŸ‡¯',
      '230': 'ðŸ‡²ðŸ‡º',
      '231': 'ðŸ‡±ðŸ‡·',
      '232': 'ðŸ‡¸ðŸ‡±',
      '233': 'ðŸ‡¬ðŸ‡­',
      '234': 'ðŸ‡³ðŸ‡¬',
      '235': 'ðŸ‡¹ðŸ‡©',
      '236': 'ðŸ‡¨ðŸ‡«',
      '237': 'ðŸ‡¨ðŸ‡²',
      '238': 'ðŸ‡¨ðŸ‡»',
      '239': 'ðŸ‡¸ðŸ‡¹',
      '240': 'ðŸ‡¬ðŸ‡¶',
      '241': 'ðŸ‡¬ðŸ‡¦',
      '242': 'ðŸ‡¨ðŸ‡¬',
      '243': 'ðŸ‡¨ðŸ‡©',
      '244': 'ðŸ‡¦ðŸ‡´',
      '245': 'ðŸ‡¬ðŸ‡¼',
      '248': 'ðŸ‡¸ðŸ‡¨',
      '249': 'ðŸ‡¸ðŸ‡©',
      '250': 'ðŸ‡·ðŸ‡¼',
      '251': 'ðŸ‡ªðŸ‡¹',
      '252': 'ðŸ‡¸ðŸ‡´',
      '253': 'ðŸ‡©ðŸ‡¯',
      '254': 'ðŸ‡°ðŸ‡ª',
      '255': 'ðŸ‡¹ðŸ‡¿',
      '256': 'ðŸ‡ºðŸ‡¬',
      '257': 'ðŸ‡§ðŸ‡®',
      '258': 'ðŸ‡²ðŸ‡¿',
      '260': 'ðŸ‡¿ðŸ‡²',
      '261': 'ðŸ‡²ðŸ‡¬',
      '263': 'ðŸ‡¿ðŸ‡¼',
      '264': 'ðŸ‡³ðŸ‡¦',
      '265': 'ðŸ‡²ðŸ‡¼',
      '266': 'ðŸ‡±ðŸ‡¸',
      '267': 'ðŸ‡§ðŸ‡¼',
      '268': 'ðŸ‡¸ðŸ‡¿',

      // Otros territorios
      '290': 'ðŸ‡¸ðŸ‡­',
      '297': 'ðŸ‡¦ðŸ‡¼',
      '298': 'ðŸ‡«ðŸ‡´',
      '299': 'ðŸ‡¬ðŸ‡±',
      '7'  : 'ðŸ‡·ðŸ‡º',
  };

  // FunciÃ³n para obtener la bandera segÃºn el nÃºmero
  const getCountryFlag = (id) => {
    const phoneNumber = id.split('@')[0];
    let phonePrefix = phoneNumber.slice(0, 3);
    if (phoneNumber.startsWith('1')) return 'ðŸ‡ºðŸ‡¸';
    if (!countryFlags[phonePrefix]) phonePrefix = phoneNumber.slice(0, 2);
    return countryFlags[phonePrefix] || 'ðŸ³ï¸â€ðŸŒˆ';
  };

  // ConstrucciÃ³n del texto a enviar
  let teks = `*${groupName}*\n\n*Integrantes : ${participants.length}*\n${pesan}\nâ”Œâ”€â”€â­“ *Despierten*\n`;

  for (const mem of participants) {
    teks += `${emoji} ${getCountryFlag(mem.id)} @${mem.id.split('@')[0]}\n`;
  }

  teks += `â””â”€â”€â”€â”€â”€â”€â”€â­“\n\nð˜šð˜¶ð˜±ð˜¦ð˜³  ð˜‰ð˜°ð˜µ ð˜žð˜©ð˜¢ð˜µð˜´ð˜ˆð˜±ð˜± ðŸš©`;

  // Enviar mensaje mencionando a todos los participantes
  await conn.sendMessage(m.chat, {
    text: teks,
    mentions: participants.map((a) => a.id),
  });
};

handler.help = ['todos *<mensaje opcional>*'];
handler.tags = ['group'];
handler.command = ['todos', 'invocar', 'tagall']
handler.admin = true;
handler.group = true;

export default handler;
