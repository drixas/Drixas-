const handler = async (m, { isOwner, isAdmin, conn, participants, args }) => {
  try {
    if (!(isAdmin || isOwner)) {
      global.dfail('admin', m, conn);
      throw false;
    }

    const chatData = global.db.data.chats[m.chat];
    const emojiTag = chatData?.emojiTag || 'â™¡ï¸°';
    const mensaje = args.length > 0 ? args.join(' ') : '';
    const groupMetadata = await conn.groupMetadata(m.chat);
    const groupName = groupMetadata.subject || 'Grupo';

    const countryFlags = {
      // AmÃ©rica y Caribe
      '1': 'ğŸ‡ºğŸ‡¸',
      '1242': 'ğŸ‡§ğŸ‡¸',
      '1246': 'ğŸ‡§ğŸ‡§',
      '1264': 'ğŸ‡¦ğŸ‡®',
      '1268': 'ğŸ‡©ğŸ‡²',
      '1284': 'ğŸ‡»ğŸ‡¬',
      '1340': 'ğŸ‡»ğŸ‡®',
      '1473': 'ğŸ‡¬ğŸ‡©',
      '1649': 'ğŸ‡¹ğŸ‡¨',
      '1664': 'ğŸ‡²ğŸ‡¸',
      '1671': 'ğŸ‡¬ğŸ‡º',
      '1758': 'ğŸ‡±ğŸ‡¨',
      '1767': 'ğŸ‡©ğŸ‡²',
      '1784': 'ğŸ‡¸ğŸ‡½',
      '1787': 'ğŸ‡µğŸ‡·',
      '1809': 'ğŸ‡©ğŸ‡´',
      '1829': 'ğŸ‡©ğŸ‡´',
      '1849': 'ğŸ‡©ğŸ‡´',
      '1868': 'ğŸ‡¹ğŸ‡¹',
      '1876': 'ğŸ‡¯ğŸ‡²',
      '52': 'ğŸ‡²ğŸ‡½',
      '53': 'ğŸ‡¨ğŸ‡º',
      '54': 'ğŸ‡¦ğŸ‡·',
      '55': 'ğŸ‡§ğŸ‡·',
      '56': 'ğŸ‡¨ğŸ‡±',
      '57': 'ğŸ‡¨ğŸ‡´',
      '58': 'ğŸ‡»ğŸ‡ª',
      '506': 'ğŸ‡¨ğŸ‡·',
      '507': 'ğŸ‡µğŸ‡¦',
      '590': 'ğŸ‡¬ğŸ‡µ',
      '591': 'ğŸ‡§ğŸ‡´',
      '592': 'ğŸ‡¬ğŸ‡¾',
      '593': 'ğŸ‡ªğŸ‡¨',
      '594': 'ğŸ‡¬ğŸ‡«',
      '595': 'ğŸ‡µğŸ‡¾',
      '596': 'ğŸ‡²ğŸ‡¶',
      '597': 'ğŸ‡¸ğŸ‡·',
      '598': 'ğŸ‡ºğŸ‡¾',
      '599': 'ğŸ‡¨ğŸ‡¼',
      '504': 'ğŸ‡­ğŸ‡³',
      '505': 'ğŸ‡³ğŸ‡®',

      // Europa
      '30': 'ğŸ‡¬ğŸ‡·',
      '31': 'ğŸ‡³ğŸ‡±',
      '32': 'ğŸ‡§ğŸ‡ª',
      '33': 'ğŸ‡«ğŸ‡·',
      '34': 'ğŸ‡ªğŸ‡¸',
      '36': 'ğŸ‡­ğŸ‡º',
      '39': 'ğŸ‡®ğŸ‡¹',
      '40': 'ğŸ‡·ğŸ‡´',
      '41': 'ğŸ‡¨ğŸ‡­',
      '43': 'ğŸ‡¦ğŸ‡¹',
      '44': 'ğŸ‡¬ğŸ‡§',
      '45': 'ğŸ‡©ğŸ‡°',
      '46': 'ğŸ‡¸ğŸ‡ª',
      '47': 'ğŸ‡³ğŸ‡´',
      '48': 'ğŸ‡µğŸ‡±',
      '49': 'ğŸ‡©ğŸ‡ª',

      // Asia y OceanÃ­a
      '60': 'ğŸ‡²ğŸ‡¾',
      '61': 'ğŸ‡¦ğŸ‡º',
      '62': 'ğŸ‡®ğŸ‡©',
      '63': 'ğŸ‡µğŸ‡­',
      '64': 'ğŸ‡³ğŸ‡¿',
      '65': 'ğŸ‡¸ğŸ‡¬',
      '66': 'ğŸ‡¹ğŸ‡­',
      '81': 'ğŸ‡¯ğŸ‡µ',
      '82': 'ğŸ‡°ğŸ‡·',
      '84': 'ğŸ‡»ğŸ‡³',
      '86': 'ğŸ‡¨ğŸ‡³',
      '90': 'ğŸ‡¹ğŸ‡·',
      '91': 'ğŸ‡®ğŸ‡³',
      '92': 'ğŸ‡µğŸ‡°',
      '93': 'ğŸ‡¦ğŸ‡«',
      '94': 'ğŸ‡±ğŸ‡°',
      '95': 'ğŸ‡²ğŸ‡²',
      '98': 'ğŸ‡®ğŸ‡·',

      // Ãfrica
      '212': 'ğŸ‡²ğŸ‡¦',
      '213': 'ğŸ‡©ğŸ‡¿',
      '216': 'ğŸ‡¹ğŸ‡³',
      '218': 'ğŸ‡±ğŸ‡¾',
      '220': 'ğŸ‡¬ğŸ‡²',
      '221': 'ğŸ‡¸ğŸ‡³',
      '222': 'ğŸ‡²ğŸ‡·',
      '223': 'ğŸ‡²ğŸ‡±',
      '224': 'ğŸ‡¬ğŸ‡³',
      '225': 'ğŸ‡¨ğŸ‡®',
      '226': 'ğŸ‡§ğŸ‡«',
      '227': 'ğŸ‡³ğŸ‡ª',
      '228': 'ğŸ‡¹ğŸ‡¬',
      '229': 'ğŸ‡§ğŸ‡¯',
      '230': 'ğŸ‡²ğŸ‡º',
      '231': 'ğŸ‡±ğŸ‡·',
      '232': 'ğŸ‡¸ğŸ‡±',
      '233': 'ğŸ‡¬ğŸ‡­',
      '234': 'ğŸ‡³ğŸ‡¬',
      '235': 'ğŸ‡¹ğŸ‡©',
      '236': 'ğŸ‡¨ğŸ‡«',
      '237': 'ğŸ‡¨ğŸ‡²',
      '238': 'ğŸ‡¨ğŸ‡»',
      '239': 'ğŸ‡¸ğŸ‡¹',
      '240': 'ğŸ‡¬ğŸ‡¶',
      '241': 'ğŸ‡¬ğŸ‡¦',
      '242': 'ğŸ‡¨ğŸ‡¬',
      '243': 'ğŸ‡¨ğŸ‡©',
      '244': 'ğŸ‡¦ğŸ‡´',
      '245': 'ğŸ‡¬ğŸ‡¼',
      '248': 'ğŸ‡¸ğŸ‡¨',
      '249': 'ğŸ‡¸ğŸ‡©',
      '250': 'ğŸ‡·ğŸ‡¼',
      '251': 'ğŸ‡ªğŸ‡¹',
      '252': 'ğŸ‡¸ğŸ‡´',
      '253': 'ğŸ‡©ğŸ‡¯',
      '254': 'ğŸ‡°ğŸ‡ª',
      '255': 'ğŸ‡¹ğŸ‡¿',
      '256': 'ğŸ‡ºğŸ‡¬',
      '257': 'ğŸ‡§ğŸ‡®',
      '258': 'ğŸ‡²ğŸ‡¿',
      '260': 'ğŸ‡¿ğŸ‡²',
      '261': 'ğŸ‡²ğŸ‡¬',
      '263': 'ğŸ‡¿ğŸ‡¼',
      '264': 'ğŸ‡³ğŸ‡¦',
      '265': 'ğŸ‡²ğŸ‡¼',
      '266': 'ğŸ‡±ğŸ‡¸',
      '267': 'ğŸ‡§ğŸ‡¼',
      '268': 'ğŸ‡¸ğŸ‡¿',

      // Otros territorios
      '290': 'ğŸ‡¸ğŸ‡­',
      '297': 'ğŸ‡¦ğŸ‡¼',
      '298': 'ğŸ‡«ğŸ‡´',
      '299': 'ğŸ‡¬ğŸ‡±',
    };

    const getCountryFlag = (jid) => {
      const phone = jid.split('@')[0];
      for (let len = 4; len >= 1; len--) {
        const prefix = phone.slice(0, len);
        if (countryFlags[prefix]) return countryFlags[prefix];
      }
      return 'ğŸ³ï¸â€ğŸŒˆ';
    };

    let texto = `*${groupName}*\n\n*Integrantes: ${participants.length}*\n`;
    if (mensaje) texto += `${mensaje}\n`;
    texto += `â”Œâ”€â”€â­“ *Despierten*\n`;

    for (const user of participants) {
      texto += `${emojiTag} ${getCountryFlag(user.id)} @${user.id.split('@')[0]}\n`;
    }

    texto += `â””â”€â”€â”€â”€â”€â”€â”€â­“\n\nğ˜šğ˜¶ğ˜±ğ˜¦ğ˜³ ğ˜‰ğ˜°ğ˜µ ğ˜ğ˜©ğ˜¢ğ˜µğ˜´ğ˜ˆğ˜±ğ˜± ğŸš©`;

    await conn.sendMessage(m.chat, { text: texto }, { quoted: m });
  } catch (e) {
    if (e) throw e;
  }
};

handler.help = ['todos *<mensaje opcional>*'];
handler.tags = ['group'];
handler.command = ['todos', 'invocar', 'tagall'];
handler.admin = true;
handler.group = true;

export default handler;
